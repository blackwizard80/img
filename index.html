<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloudinary Chat - Full Features</title>
<style>
:root {
  --bg-color:#000;
  --text-color:#fff;
}
body {
  margin:0; padding:0; background:var(--bg-color); color:var(--text-color); font-family:Arial,sans-serif;
}
#messages {
  position: fixed; top:0; left:0; width:100%; height:calc(100vh - 120px);
  overflow-y:auto; padding:10px 10px 130px 10px; box-sizing:border-box;
  display:flex; flex-direction:column; gap:10px;
}
#sendMsg {
  position: fixed; bottom:0; left:0; width:100%; background:#111;
  display:flex; justify-content:space-around; align-items:center;
  padding:10px; box-sizing:border-box; flex-wrap:wrap; gap:5px;
}
.upload-btn {width:40%; min-width:100px; height:50px; background:#444; color:#fff; border:none; border-radius:10px; font-size:14px; cursor:pointer;}
.outer {display:flex; flex-shrink:0; position:relative;}
.me,.notMe {
  padding:5px; border-radius:10px; max-width:80%; display:inline-block;
  word-wrap:break-word; position:relative;
}
.me {background:#0066ff; color:#fff; text-align:right; margin-left:auto;}
.notMe {background:#333; color:#fff; text-align:left; margin-right:auto;}
.mediaMsg {width:100%; height:auto; max-height:50vh; object-fit:contain; border-radius:10px; display:block; margin-top:5px; cursor:pointer;}
video.mediaMsg, img.mediaMsg {width:100%; max-height:50vh;}
.delete-btn,.retry-btn,.cancel-btn {
  display:block; margin-top:5px; background:#ff4d4d; color:#fff;
  border:none; border-radius:5px; padding:5px; font-size:0.8em; cursor:pointer;
}
.delete-btn {position:absolute; bottom:4px; left:4px;} /* Lower-left delete button */
.retry-btn {background:#ffa500;}
.cancel-btn {background:#888;}
.time {font-size:0.7em; color:#ccc; margin-top:5px;}
.progress-container {background:#222; border-radius:5px; margin-top:5px; overflow:hidden; height:10px; position:relative;}
.progress-bar {height:10px; background:#00ff66; width:0%; transition:width 0.2s ease;}
.progress-percent {position:absolute; right:5px; top:-1px; font-size:0.7em; color:#fff;}
#messages::-webkit-scrollbar {width:8px;}
#messages::-webkit-scrollbar-thumb {background:#444; border-radius:4px;}
.drag-over {border:2px dashed #00ff66;}

/* Fullscreen modal */
#fullscreenModal {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:9999;
}
#fullscreenModal img, #fullscreenModal video {
  max-width:95%; max-height:95%; border-radius:10px; object-fit:contain;
}

/* Reaction */
.reaction-bubble {transition: transform 0.2s ease, opacity 0.2s ease;}
.reaction-bubble:hover {transform: scale(1.15); opacity: 0.9;}
.reaction-bar {
  position:absolute; display:flex; gap:8px; background:#222;
  padding:6px 8px; border-radius:20px; box-shadow:0 2px 10px rgba(0,0,0,0.4); z-index:1000;
}
.reaction-bar span {cursor:pointer; font-size:20px; transition:transform 0.2s;}
.reaction-bar span:hover {transform:scale(1.2);}
</style>
</head>
<body>

<div id="messages"></div>
<div id="sendMsg">
  <button class="upload-btn" id="imgUploadBtn">Upload Images</button>
  <button class="upload-btn" id="vidUploadBtn">Upload Videos</button>
  <input type="file" id="imgUpload" style="display:none;" accept="image/*" multiple>
  <input type="file" id="vidUpload" style="display:none;" accept="video/*" multiple>
</div>

<div id="fullscreenModal"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getDatabase, ref, set, remove, onChildAdded, onChildRemoved, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

const firebaseConfig = { apiKey:"AIzaSyDPhDXeo4Z5bTQxwpW-HTg1UmGFLaO14wY",
 authDomain:"blacki-a15b9.firebaseapp.com",
 databaseURL:"https://blacki-a15b9-default-rtdb.firebaseio.com",
 projectId:"blacki-a15b9",
 storageBucket:"blacki-a15b9.firebasestorage.app",
 messagingSenderId:"672500956723",
 appId:"1:672500956723:web:0b7433bb51ef07c86b2d46" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const cloudName = "dk34hm7pe";
const unsignedUploadPreset = "videonew";

let sender = sessionStorage.getItem("sender") || prompt("Enter your name:");
sessionStorage.setItem("sender", sender);

const messagesDiv = document.getElementById("messages");
const imgUploadBtn = document.getElementById("imgUploadBtn");
const vidUploadBtn = document.getElementById("vidUploadBtn");
const imgUpload = document.getElementById("imgUpload");
const vidUpload = document.getElementById("vidUpload");
const fullscreenModal = document.getElementById("fullscreenModal");

function scrollToBottom(){requestAnimationFrame(()=>{messagesDiv.scroll({top:messagesDiv.scrollHeight,behavior:"smooth"});});}

async function uploadToCloudinary(file,tempDiv){
  return new Promise((resolve,reject)=>{
    const progressBar=tempDiv.querySelector(".progress-bar");
    const percentSpan=tempDiv.querySelector(".progress-percent");
    const url=`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`;
    const xhr=new XMLHttpRequest();
    const formData=new FormData();
    formData.append("file",file);formData.append("upload_preset",unsignedUploadPreset);
    const startTime=Date.now();
    xhr.open("POST",url);
    xhr.upload.addEventListener("progress",e=>{
      if(e.lengthComputable){
        const percent=Math.round((e.loaded/e.total)*100);
        progressBar.style.width=percent+"%";
        const speed=e.loaded/((Date.now()-startTime)/1000);
        const eta=(e.total-e.loaded)/speed;
        percentSpan.textContent=`${percent}% - ${(speed/1024).toFixed(1)} KB/s - ETA: ${eta.toFixed(1)}s`;
      }
    });
    xhr.onload=()=>{try{const data=JSON.parse(xhr.responseText);if(data.secure_url)resolve(data.secure_url);else reject("Upload failed");}catch{reject("Upload failed");}};
    xhr.onerror=()=>reject("Network error");
    const cancelBtn=tempDiv.querySelector(".cancel-btn");
    cancelBtn.addEventListener("click",()=>{xhr.abort();tempDiv.remove();});
    xhr.send(formData);
  });
}

function createTempBubble(name,type){
  const tempId="upload-"+Date.now();
  const div=document.createElement("div");div.classList.add("outer");div.id=tempId;
  div.innerHTML=`<div class="me"><b>${name}</b><div>Uploading ${type}...</div>
  <div class="progress-container"><div class="progress-bar"></div><span class="progress-percent">0%</span></div>
  <button class="cancel-btn">Cancel</button></div>`;
  messagesDiv.appendChild(div);scrollToBottom();return div;
}

async function handleFiles(files,type){
  for(let file of files){
    const tempDiv=createTempBubble(sender,type);
    const uploadFile=async ()=>{
      const msgDiv=tempDiv.querySelector(".me");
      msgDiv.querySelector(".progress-bar").style.width="0%";
      msgDiv.querySelector(".progress-percent").textContent="0%";
      try{
        let url=await uploadToCloudinary(file,tempDiv);
        if(type==="video") url+="?tr=so_0";
        const timestamp=Date.now();
        await set(ref(db,"messages/"+timestamp),{sender,msg:url,type,time:new Date().toLocaleString()});
        tempDiv.remove();
      }catch{
        msgDiv.innerHTML=`<b>${sender}</b> Upload failed <button class="retry-btn">Retry</button>`;
        const retryBtn=msgDiv.querySelector(".retry-btn");
        retryBtn.addEventListener("click",uploadFile);
        setTimeout(()=>{if(tempDiv.parentNode)tempDiv.remove();},5000);
      }
    };
    uploadFile();
  }
}

imgUploadBtn.addEventListener("click",()=>imgUpload.click());
imgUpload.addEventListener("change",()=>handleFiles(Array.from(imgUpload.files),"image"));
vidUploadBtn.addEventListener("click",()=>vidUpload.click());
vidUpload.addEventListener("change",()=>handleFiles(Array.from(vidUpload.files),"video"));

document.body.addEventListener("dragover",e=>{e.preventDefault();messagesDiv.classList.add("drag-over");});
document.body.addEventListener("dragleave",e=>{e.preventDefault();messagesDiv.classList.remove("drag-over");});
document.body.addEventListener("drop",e=>{
  e.preventDefault();messagesDiv.classList.remove("drag-over");
  const files=Array.from(e.dataTransfer.files);
  const images=files.filter(f=>f.type.startsWith("image/"));
  const videos=files.filter(f=>f.type.startsWith("video/"));
  if(images.length)handleFiles(images,"image");
  if(videos.length)handleFiles(videos,"video");
});

onChildAdded(ref(db,"messages"),snapshot=>{
  const {sender:msgSender,msg,type,time,reactions}=snapshot.val();
  const isMe=msgSender===sender;
  let mediaHTML="";
  if(type==="image") mediaHTML=`<img src="${msg}" class="mediaMsg">`;
  else if(type==="video") mediaHTML=`<video src="${msg}" class="mediaMsg" controls></video>`;

  const msgDiv=document.createElement("div");
  msgDiv.classList.add("outer");msgDiv.id=snapshot.key;
  msgDiv.innerHTML=`<div class="${isMe?"me":"notMe"}">
    <div><b>${msgSender}</b></div>${mediaHTML}
    <div class="time">${time}</div>
    ${isMe?`<button class="delete-btn" data-key="${snapshot.key}">Delete</button>`:""}</div>`;
  messagesDiv.appendChild(msgDiv);scrollToBottom();
  renderReactionBubble(msgDiv,reactions);
});

messagesDiv.addEventListener("click",e=>{
  if(e.target.classList.contains("delete-btn")){
    const key=e.target.getAttribute("data-key");
    remove(ref(db,"messages/"+key));
  }
});

messagesDiv.addEventListener("click",e=>{
  const target=e.target;
  if(target.classList.contains("mediaMsg")){
    fullscreenModal.style.display="flex";
    fullscreenModal.innerHTML="";
    if(target.tagName==="IMG"){const img=document.createElement("img");img.src=target.src;fullscreenModal.appendChild(img);}
    else if(target.tagName==="VIDEO"){const vid=document.createElement("video");vid.src=target.src;vid.controls=true;vid.autoplay=true;fullscreenModal.appendChild(vid);}
  }
});
fullscreenModal.addEventListener("click",()=>{fullscreenModal.style.display="none";fullscreenModal.innerHTML="";});

const reactionEmojis=["ðŸ˜…","â¤ï¸â€ðŸ©¹","ðŸ˜˜","ðŸ¥¹","ðŸ™‚","ðŸ˜‚","ðŸ˜","ðŸ‘","ðŸ”¥"];
let pressTimer;
messagesDiv.addEventListener("touchstart",handleLongPressStart);
messagesDiv.addEventListener("mousedown",handleLongPressStart);
messagesDiv.addEventListener("touchend",handleLongPressEnd);
messagesDiv.addEventListener("mouseup",handleLongPressEnd);
function handleLongPressStart(e){const target=e.target;if(target.classList.contains("mediaMsg")){pressTimer=setTimeout(()=>showReactionBar(target),600);}}
function handleLongPressEnd(){clearTimeout(pressTimer);}
function showReactionBar(target){
  document.querySelectorAll(".reaction-bar").forEach(bar=>bar.remove());
  const msgBubble=target.closest(".outer");if(!msgBubble)return;
  const bar=document.createElement("div");bar.className="reaction-bar";
  const rect=target.getBoundingClientRect();
  bar.style.left=rect.left+window.scrollX+(rect.width/2 - 100)+"px";
  bar.style.top=rect.top+window.scrollY+(rect.height/2 - 25)+"px";
  reactionEmojis.forEach(emoji=>{
    const btn=document.createElement("span");btn.textContent=emoji;
    btn.addEventListener("click",async ()=>{
      const msgKey=msgBubble.id;
      const reactionRef=ref(db,"messages/"+msgKey+"/reactions/"+sender);
      onValue(reactionRef,snap=>{
        const current=snap.val();
        if(current && current.emoji===emoji){set(reactionRef,null);}
        else{set(reactionRef,{emoji,by:sender});}
      },{onlyOnce:true});
      bar.remove();
    });
    bar.appendChild(btn);
  });
  document.body.appendChild(bar);
  setTimeout(()=>bar.remove(),4000);
}

onValue(ref(db,"messages"),snapshot=>{
  snapshot.forEach(childSnap=>{
    const msgEl=document.getElementById(childSnap.key);
    if(msgEl) renderReactionBubble(msgEl,childSnap.val().reactions);
  });
});

function renderReactionBubble(msgEl,reactions){
  if(!msgEl) return;
  const inner=msgEl.querySelector(".me, .notMe");if(!inner) return;
  inner.querySelectorAll(".reaction-bubble").forEach(b=>b.remove());
  if(!reactions) return;
  inner.style.position="relative";
  
  const startBottom=22; // â†‘ position above time label
  let index=0;
  Object.values(reactions).forEach(r=>{
    if(!r || !r.emoji) return;
    const bubble=document.createElement("div");
    bubble.className="reaction-bubble";
    bubble.style.position="absolute";
    bubble.style.right="5px";
    bubble.style.bottom=(startBottom + index*22)+"px";
    bubble.style.background="#222";
    bubble.style.color="#fff";
    bubble.style.padding="2px 6px";
    bubble.style.borderRadius="14px";
    bubble.style.fontSize="16px";
    bubble.style.display="flex";
    bubble.style.alignItems="center";
    bubble.style.gap="5px";
    bubble.style.boxShadow="0 0 6px rgba(0,0,0,0.4)";
    bubble.style.cursor="pointer";
    bubble.style.userSelect="none";
    bubble.textContent=r.emoji;
    const name=document.createElement("span");
    name.style.fontSize="10px";
    name.style.color="#ccc";
    name.textContent=r.by;
    bubble.appendChild(name);
    bubble.addEventListener("click",e=>{e.stopPropagation();showReactionBar(inner.querySelector(".mediaMsg"));});
    inner.appendChild(bubble);
    index++;
  });
}

onChildRemoved(ref(db,"messages"),snapshot=>{const el=document.getElementById(snapshot.key);if(el) el.remove(); setTimeout(scrollToBottom,100);});
</script>
</body>
</html>
